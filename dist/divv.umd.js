!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).divv={})}(this,(function(t){"use strict";const e={PROPS:Symbol("props"),ROOT:Symbol("root"),OBSERVER:Symbol("observer"),EMITTER:Symbol("emitter"),INSERTED_EMITTER:Symbol("inserted-emitter"),IS_PROXY:Symbol("isProxy"),PROXY_OBSERVE:Symbol("proxyObserve")},n={EMIT:"emit",CHILDREN:"_children",STYLESHEET:"_stylesheet",ID:"_id"},o={func:t=>"function"==typeof t,str:t=>"string"==typeof t,obj:t=>"object"==typeof t,arr:Array.isArray},r=()=>Math.random().toString(32).substring(2),s=t=>o.obj(t)?o.arr(t)?[...t]:{...t}:t,a=(t,e)=>{for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&t[n]&&o.obj(t[n])&&l(t[n],e,n,t)};function c(t,n){return new Proxy(t,{get:(t,n,o)=>n===e.IS_PROXY||Reflect.get(t,n,o),set:function(t,e,o,r){const a=s(t[e]);return Reflect.set(t,e,o,r),n({key:e,value:o,oldValue:a,operation:"set",data:r.valueOf()}),!0},deleteProperty(t,e){const o=t[e];return delete t[e],n({key:e,value:void 0,oldValue:o,operation:"delete",data:t}),!0}})}function i(t,n){const r=(()=>{let t,e;return{skip:(n,o)=>{const r=Number(o),s=n.length-1;if(/(un)?shift|push|pop/.test(t)){if(!isNaN(r))return!0;e=void 0}if("sort"===t&&r!==s)return!0},old:()=>e,method:(n,r)=>{if(!r)return t;o.str(r)&&/push|pop|(un)?shift|splice|sort/.test(r)&&(t=r),/(un)?shift|push|pop/.test(t)&&!e&&(e=[...n])}}})();return new Proxy(t,{get:(t,n,o)=>n===e.IS_PROXY||(r.method(t,n),Reflect.get(t,n,o)),set:function(t,e,o,a){const c=r.old()||s(t);return Reflect.set(t,e,o,a),r.skip(t,e)||c===o||n({key:e,value:s(t),oldValue:c,operation:r.method(),meta:r.isArray&&{item:t[e],index:e},data:a.valueOf()}),!0}})}function l(t,n,r,s,l){if(!t||!o.obj(t))return t;const d=function(t,n,o,r){if(n[e.IS_PROXY])return n;const s=[o],c=t(n,o=t=>s.forEach((e=>e(t))));return n[e.IS_PROXY]=!0,n[e.PROXY_OBSERVE]=t=>{!s.some((e=>e===t))&&s.push(t)},!r&&a(n,o),c}(o.arr(t)?i:c,t,n,l);return r&&s&&(s[r]=d),d}const d=/@/g,u=/(^|\s)\/(\/|\*)/,f=/^:?(else)?-?(if)?$/,p=/^[\s\t]{0,}\/\//,h=t=>t.replace(d,""),m=(t,e={})=>(t=h(t),p.test(t)?(e.isEval=!0,e.token=t.replace(p,"").trim(),e):(t.startsWith("!")&&(t=t.substring(1),e.not=!0),e.token=t,t.includes(".")&&(t=t.split(".")[0]),t.includes("]")&&(t=t.replace(/\[.*/,"")),e.prop=t,e));function E(t,e,n){const o=t.parentElement,s=t.textContent;if(s){if(8===t.nodeType)return{type:"comment",text:s};if(3===t.nodeType){if(!e&&u.test(s))return;const t=e&&p.test(s),n={isTemplate:d.test(s),isEval:t,type:"text",text:s};return t&&m(s,n),n}}if(1!==t.nodeType)return;const a=t.tagName.toLowerCase(),c={type:"tag",name:a,attrs:{},children:[],events:[]},i=(t,e)=>{c.isLoop=!0,c.isBlock=e;let[n,,o]=t;if("{"===n)return Object.assign(c,{prop:h(t.pop()),alias:t.slice(1,-2).map((t=>{const e=t.indexOf(",");return-1!==e&&(t=t.substring(0,e)),h(t.trim())})),destructured:!0});Object.assign(c,{prop:h(o),alias:h(n)})},l=(t,e,n)=>{o._id=o._id||r(),c.condition={key:t,id:o._id},c.isBlock=n,c.isLoop?m(e,c.condition):m(e,c)};"else"===a&&l(a,"",!0);for(const{name:r,value:d}of t.attributes){if("for"===a){i(Array.from(t.attributes).map((t=>t.name)),!0);break}if("for"!==r){if(f.test(a)){l(a,r,!0);break}if(f.test(r))l(r,d);else if(r.startsWith("@")){const t=h(r),e=h(d);if("html"===t){c.text=e,c.isHTML=!0,m(d,c);continue}c.events.push({func:e,event:t})}else d.includes("@")?(c.reactiveAttrs=c.reactiveAttrs||[],c.reactiveAttrs.push({key:r,value:d})):"ref"!==r?c.attrs[r]=d:c.ref=d}else i(d.split(" "))}for(const r of t.childNodes){const t=E(r,!0);t&&(("text"!==t.type||t.isTemplate)&&(n=!0),c.children.push(t))}return c.condition||n&&!c.isHTML||(c.isHTML||(c.text=s),delete c.children),c.text&&m(c.text,c),c}const b=t=>"function"==typeof t?t():t,v=(t,e)=>{try{return b(new Function(...Object.keys(e),`return ${t.trim()}`).apply(null,Object.values(e)))}catch(n){return console.warn(n.message,t),t}},y=(t,e)=>{if(!o.obj(e)||!o.str(t)||!t.length)return t;const n=t.split(/[\[\]\?\.]/).filter(Boolean);for(let o of n){if(void 0===e[o])return;e=e[o]}return b(e)},T=(t,e,n="",r,s,a)=>{const c=n?new RegExp("@"+(r?`(${n.join("|")})`:`${n}(?:\\.)?([a-z0-9\\[\\].]+)?`),"gi"):/@([a-z0-9\[\].]+)/gi;return e.replace(c,((e,n)=>n?r&&"index"===n?s:o.obj(t)?(a?v:y)(n,t):t:b(t)))},O=(t,e)=>e[t]?t:Object.keys(e).find((e=>e.toLowerCase()===t)),R=(t="",e)=>{let n,o=e;const r=t.split(".").reduce(((t,e)=>{if(!e.trim())return t;const[r]=e.match(/[^\s\[\]]+/),s=O(r,o)||r;return n||(n=s),t.push(e.replace(r,s)),"object"!=typeof o||(o=o[s]),t}),[]);return{prop:n,token:r.join(".")}},g=(t,e,n)=>{t[e]=t[e]||[],t[e].some((t=>t===n))||t[e].push(n)},S={},x={},w=(t,e,n,o)=>{n&&(g(S,t,e),((t,e,n,o)=>{x[n]=x[n]||{},x[n][t]=S[t],M(o[n],n,e,o)})(t,e,n,o),M(o,n,e,o)),e()},j={},k={},M=(t,n,r,s)=>{if("object"==typeof t){if(o.arr(s[n])&&g(k,n,r),t[e.IS_PROXY])return t[e.PROXY_OBSERVE](r);l(t,r,O(n,s),s)}},C=(t,e,n,o)=>{M(t,e,n,o),g(j,e,n),n()};let N;const I={},L=t=>{const{key:e,value:n,operation:o,data:r}=t;"set"===o&&k[e]&&k[e].forEach((t=>C(r[e],e,t,r))),N=JSON.stringify(n),I[e]!==N&&(I[e]=N,j[e]&&j[e].forEach((e=>e(t))),x[e]&&Object.values(x[e]).forEach((e=>e.forEach((e=>e(t))))))},P=(t,e)=>{const{data:r,refs:s}=t,a=(t,n)=>{const{alias:a,prop:c,destructured:i,isBlock:l,children:d=[]}=n,{token:u}=R(c,r),f=y(u,r);if(l&&!d.length)return;if(!f||!o.arr(f))return;const p=e("span",t),h=l?d:[n];delete n.isLoop;const m=t=>{t.forEach(((t,e)=>{const n=((t,e)=>{const n=o=>{o.isEval&&!o.condition&&(o.text=v(o.token,{...t,index:e}),delete o.isEval),o.isTemplate&&(o.text=T(t,o.text,a,i&&u,e),delete o.isTemplate),o.reactiveAttrs&&(o.reactiveAttrs.forEach((({key:n,value:r})=>{o.attrs[n]=T(t,r,a,i&&u,e,o.isEval)})),delete o.reactiveAttrs),o.condition&&(o.loopState={...t,index:e}),o.children&&o.children.forEach(n)},o=h.map((t=>JSON.parse(JSON.stringify(t))));return o.forEach(n),o})(t,e);n.forEach((t=>b(p,t)))}))};C(f,u,(()=>{p.innerHTML="",m(y(u,r)),Object.entries(s).forEach((([t,e])=>{Array.isArray(e)&&(s[t]=e.filter((t=>t.offsetParent)))}))}),r)},c=(t,e)=>{e.children.length&&(delete e.isBlock,e.name="span",b(t,e))},i=(t,e)=>{const{type:n="text",text:o=""}=e,r=[],s=[];return o.replace(/(\\)?@([^\s<]+)/g,((t,e,n)=>(r.push((e?"@":"")+n),s.push(e),"χ"))).split("χ").flatMap((t=>{const e=r.shift(),o=s.shift();return[t&&{type:n,text:t},e&&{...m(e),type:"text",text:e,isProp:!o}]})).filter(Boolean).forEach((e=>b(t,e)))},l=(t,n)=>{const{type:o,name:r,attrs:s={},text:a=""}=n;return e(...[r||o,t,{tag:r||o,text:a,attrs:s,passive:!0}].filter(Boolean))},d=(t,e)=>{const{reactiveAttrs:n}=t;n.forEach((({key:t,value:n,prop:o})=>{C(r,o,(()=>e.setAttribute(t,T(r,n))),r)}))},u=(t,e)=>{const{isEval:n,isHTML:s,token:a}=t,c=n?(i=a,Array.from(i.split(" ").reduce(((t,e)=>{if(!(e=e.replace(/@/g,"").trim()))return t;const[n]=e.split(/\[|\./).map((t=>t.replace(/^!/,"")));return/[a-zA-Z]{2,}/.test(n)&&r[n]&&t.add(n),t}),new Set))):t.prop;var i;const l=n?v:y,d=()=>e[s?"innerHTML":"textContent"]=l(a,r);(o.arr(c)?c:[c]).forEach((t=>C(r,t,d,r)))},f=(e,o)=>{e.forEach((({func:e,event:a})=>{if(!t[e])return console.warn(`@${a} ${e} not declared`);o[n.EMIT]=o[n.EMIT]||((t,e)=>o.dispatchEvent(new CustomEvent(t,{detail:e}))),o.addEventListener(a,(n=>{o.refs=s,o.data=r,t[e].call(o,n)}))}))};let p={};const h=(t,n)=>{const{isEval:o,not:s,condition:a,token:c,loopState:i}=t,{key:l,id:d}=a,{prop:u,token:f}=i&&a.prop?a:R(c,r),h="else"===l,m=o?v:y,E=(()=>{const t=n.parentElement;return n.placeholder=e("comment",t),e=>{e?t.insertBefore(n,n.placeholder):n.remove()}})();w(d,(()=>{"if"===l&&(p={});const t=!h&&f&&m(f,i||r),e=s?!t:!!t,n=h?!p.fulfilled:("if"===l||!p.fulfilled)&&e;a.fulfilled="else-if"===l?p.fulfilled||!p.fulfilled&&e:n,p=a,E(n)}),u,i||r)},E=(t,e)=>{let{ref:n,name:r}=t;n=n||e.id||e.className&&e.className.split(" ")[0]||r,n&&((t,e,n)=>{if(t[e])return o.arr(t[e])||(t[e]=[t[e]]),void t[e].push(n);t[e]=n})(s,n,e)};function b(t,e){const{isLoop:n,condition:o,isTemplate:r,reactiveAttrs:s,isHTML:p,isProp:m,isEval:v,isBlock:y,children:T=[],events:O=[]}=e;if(n)return a(t,e);if(o&&y)return c(t,e);if(r)return i(t,e);const R=l(t,e);return s&&d(e,R),(p||m||v&&!o)&&u(e,R),o&&h(e,R),E(e,R),f(O,R),T.forEach((t=>b(R,t))),R}return b},A=(t,e)=>{const{props:n,tag:o,parent:r={}}=t;n.refs=[],l(n.data||{},L,"data",n);const s=P(n,e);((t,e=[])=>{const n=(new DOMParser).parseFromString(t,"text/html");for(const o of n.body.childNodes){const t=E(o);t&&e.push(t)}return e.flat()})(o).forEach((t=>s(r,t))),n.inserted&&n.inserted.call(e("span",n))},_=(t,e,n)=>{e.off=e.off||(t=>e.off._list[t]&&e.off._list[t]()),e.off._list=Object.assign(e.off._list||{},{[t]:n})},H=(t,e)=>(n,o)=>{const r=r=>(o.call(t,r),e&&t.off(n));t.addEventListener(n,r),_(n,t,(()=>t.removeEventListener(n,r)))},B=t=>{const{props:{passive:n,inserted:o,isChild:r},node:s,parent:a}=t;if(!a)return t;const c=s.customConstructor;if(!c&&(n||!o))return t;const i=a.host||a,l=()=>{c?c.call(s):o.call(s,a)};if(r){if(i[e.ROOT][e.INSERTED_EMITTER])return i[e.ROOT][e.INSERTED_EMITTER].push(l),t;i[e.ROOT]=a}return i[e.INSERTED_EMITTER]=[l],new MutationObserver(((t,n)=>{for(const o of t)for(const t of o.addedNodes)if(t===s){n.disconnect(),i[e.INSERTED_EMITTER].forEach(l);break}})).observe(a,{childList:!0}),t},$=(t,n)=>o=>{t[e.OBSERVER]&&t[e.OBSERVER]({type:n,...o}),t[e.PROPS]&&t[e.PROPS].on[n]&&t.dispatchEvent(new CustomEvent(n,{detail:o}))};function D(t){const{props:n,node:o}=t;n.observe&&function(t,n){t[e.OBSERVER]=n.bind(t);const o=$(t,"attribute"),r=Array.from(t.attributes).reduce(((t,e)=>Object.assign(t,{[e.name]:e.value})),{}),s=new MutationObserver((t=>t.forEach((t=>{const e=t.target.getAttribute(t.attributeName)??void 0,n=r[t.attributeName];e!==n&&o({key:t.attributeName,value:e,oldValue:n}),r[t.attributeName]=e}))));s.observe(t,{attributes:!0}),_("observe",t,(()=>s.disconnect()))}(o,n.observe)}function Y(t){const{props:e,node:n}=t;let{state:r,passive:s}=e;s||(o.obj(r)||(console.warn("[state] must be of type object. value moved to state.value"),r={value:r}),l(r,$(n,"state"),"state",n),n.observe=function(t){return(e={},n)=>o.obj(e)?t||!n||o.func(n)?l(e,n?t=>n(Object.assign({type:"observe",data:e},t)):$(t,"observe")):console.warn("callback not specified"):console.warn("[argument] must be of type object")}(n))}const V=(t,e)=>e.replace(new RegExp(`${t}|(?!^|[\\s\\t\\r\\n]+)body(?=[\\s\\{])`,"g"),":host"),X=(t,n,r)=>{const s=n.shadowRoot?":host":n.localName;return r.host[e.STYLESHEET].textContent+=(o.obj(t)?((t,n,o)=>{const[r,s,a]=Object.entries(n).reduce(((t,[e,n])=>{const r="css"===e,s="cssText"===e;var a;return t[r?2:s&&!o.shadowRoot?1:0]+=r||s?n:`${a=e,a.replace(/[A-Z]/g,(t=>`-${t.toLowerCase()}`))}: ${n};`,t}),["","",""]);return[a&&V(o.localName,a),r&&`${t} {${r}}`,s&&(o.setAttribute(o[e.ID],"")||`${t}[${o[e.ID]}] {${s}}`)].filter(Boolean).join("")})(s,t,n):V(n.localName,t)).replace(/\s{2,}/g," ")};function z(t,e,n){const{style:o,textContent:r,innerHTML:s,template:a,on:c}=e;if(o&&X(o,{shadowRoot:!0,localName:t},n),r&&n.appendChild(document.createTextNode(r)),s){n.appendChild(document.createElement("span")).innerHTML=s}if(a){n.appendChild(document.createElement("span")).innerHTML=a}c&&Object.entries(c).forEach((([t,e])=>H(this,"once"===t)(t,e)))}function J(t){const{props:n,tag:o,parent:r}=t,s=o.replace(/[^a-zA-Z-]/g,""),a=customElements.get(s);if(a)return t.node=new a;const{constructor:c,connected:i,disconnected:l,adopted:d}=n;class u extends HTMLElement{constructor(){super(),t.node=this;const o=this.attachShadow({mode:"open"});this[e.STYLESHEET]=o.appendChild(document.createElement("style")),z.call(this,s,n,o),o.appendChild(document.createElement("slot"))}}const f=u.prototype;i&&(f.connectedCallback=i),l&&(f.disConnectedCallback=l),d&&(f.adoptedCallback=d),c&&(f.customConstructor=c),customElements.define(s,u),new u}const Z=["style","css","on","text","textContent","html","innerHTML"],F=["constructor","connected","disconnected","adopted","template"],W=["watch","observe","state","fetch","isChild"],U=t=>{const{props:e,node:n,parent:o}=t;return e.created&&e.created.call(n,o),t},q=(t,n,o,r)=>{t.forEach((t=>{const s=t.tag;s?delete t.tag:console.warn("created child without [tag] property, defaults to div");const a=n.host||n;o[e.ROOT]=a[e.ROOT]||a,t.isChild=!0,st(s||"div",r||o,t)}))},G=t=>(e,n)=>t.setAttribute(e,n),K=t=>(e,n)=>t[e]=n;function Q(t){const{props:e,node:n,shadow:r,selfShadow:s}=t;return function e(n,a,c){Object.entries(n).forEach((([n,i])=>{if(!W.includes(n)){if(r){if(s&&Z.includes(n))return;if("style"===n)return X(i,a,r)}return"className"===n&&o.obj(i)&&(i=Object.values(i).filter(Boolean).join(" ")),o.obj(i)?"children"===n?q(i,t):"on"===n?e(i,a,H(a,"once"===n)):"style"===n||"dataset"===n?e(i,a,K(a[n])):/^attr/.test(n)?e(i,a,G(a)):void(a[n]=i):c?c(n,i):K(a)(n,i)}}))}(e,n),t}const tt=t=>{const{node:e,parent:n}=t;t.parentShadow=n&&(n.shadowRoot||n.host&&!/localhost|www/.test(n.host)&&n),t.selfShadow=e.shadowRoot,t.shadow=t.selfShadow||t.parentShadow};function et(t){const e=()=>{const{node:e,parent:n,parentShadow:o}=t;n&&(o||n).appendChild(e)};return function(t,e){const{props:{fetch:n},node:r}=t;if(!n)return;r.data=r.data||{};const s=Object.entries(n).map((([t,e])=>{const[n,s={}]=o.str(e)?[e]:[e.url,e.options],a=e=>$(r,"fetch")({key:t,path:`this.data.${t}`,url:n,value:e});return fetch(n,s).then((t=>200!==t.status?a({error:t.status}):t[/json/.test(t.headers.get("content-type"))?"json":"text"]())).then((e=>{r.data[t]=e,a(e)})).catch((t=>{a({error:t.message})}))}));return Promise.all(s).then(e)}(t,e)||e(),t}const nt=t=>{const{node:n,selfShadow:o}=t;return n[e.CHILDREN]=Array.from((o||n).children).filter((t=>"style"!==t.localName)),n};function ot(t){const{props:o,parent:s,isCustom:a}=t;return a&&J(t),t.node[e.PROPS]=o,t.node[e.ID]=r(),D(t),function(t,o){const{props:r,node:s}=t;if(r.passive)return;const a=o.host||o||{},c=$(s,"event");s[e.EMITTER]=a[e.EMITTER]||[],s[e.EMITTER].push(s),s[n.EMIT]=(t,n)=>{const o=new CustomEvent(t,{detail:n});s[e.EMITTER].forEach((t=>t!==s&&t.dispatchEvent(o))),c({key:t,value:n})}}(t,a?t.node:s),Y(t),tt(t),t}function rt(t){const{props:e,tag:n}=t,r={class:"className",html:"innerHTML",text:"textContent",css:"style",constructor:"constructor"},s={css:t=>({cssText:t}),style:t=>o.str(t)?{css:t}:t},a={on:{},state:{},...e};return t.node=document.createElement(n),t.isCustom=t.node instanceof HTMLUnknownElement||n.includes("-"),t.props=Object.entries(a).reduce(((e,[n,o])=>{var a;if(!t.isCustom&&F.includes(n))return console.warn(`"${n}" is not valid for standard HTML elements`),e;const c=r[n]||n,i=(null==(a=s[n])?void 0:a.call(s,o))||o;return e[c]="style"===c?Object.assign(e[c]||{},i):i,e}),Object.create(null)),t}function st(){const t=[...arguments],e=t.shift(),n=(t[0]instanceof Element||t[0]instanceof ShadowRoot)&&t.shift(),r=t.shift()||{};return/</.test(e)?A({tag:e,parent:n,props:r},st):/^(text|comment)$/.test(e)?function(t,e=document.body,n){const r=o.str(n),s=document["text"===t?"createTextNode":"createComment"](r?n:n.text);return!r&&n.inserted&&B({props:n,node:s,parent:e}),e.appendChild(s)}(e,n,r):[rt,ot,B,Q,U,et,nt].reduce(((t,e)=>e(t)),{tag:e,parent:n,props:r})}t.divv=st,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})}));
